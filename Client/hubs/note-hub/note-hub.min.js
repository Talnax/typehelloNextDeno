var th=th||{};th.next=th.next||{};
th.next.NoteHub=function(f){function r(){b=this;this.cssClassHub=".note-hub";this.hubStatus=statusHub.not_active;this.noteTemplate=this.userPerClick=null;this.searchResults=[];this.noteChanged=this.collapseCss=!1;this.posFormatting=null;this.feedbackClass=".note-hub-dlg-feedback";this.settingsClass=".note-hub-dlg-settings";this.commonHub=new th.next.CommonHub(this);this.Initialize()}function m(g){try{g.preventDefault();if(0===ctrlNote.listNotePosts.length)return!1;var k=f("#input-search-notes").val().toLowerCase();
if(!isDefine(k)||""===k)return!1;b.showProgressBar(!0);b.collapseCss=!1;a:try{var p=k.split(/,| /);for(g=0;g<p.length;g++)""===p[g]&&p.splice(g,1);b.searchResults=null;b.searchResults=[];for(g=0;g<p.length;g++){var t=p[g];if(""===t)break a;for(k=0;k<ctrlNote.listNotePosts.length;k++){var c=ctrlNote.listNotePosts[k];if(-1<c.note.title.toLowerCase().indexOf(t)||-1<c.note.msg.toLowerCase().indexOf(t)||-1<c.note.tags.toLowerCase().indexOf(t)){for(var a=!1,h=0;h<b.searchResults.length;h++)if(b.searchResults[h].note.id===
c.note.id){a=!0;break}a||b.searchResults.push(c)}}}0<b.searchResults.length&&b.refreshUI(b.searchResults)}catch(d){console.log("ERROR(NoteHub.searchRoutine()): "+d)}b.showProgressBar(!1);return!1}catch(e){return console.log("ERROR(NoteHub.onSearch_Click()): "+e),!1}}function l(g){try{g.preventDefault();var k=g.target,p=k.getAttribute("data-action"),c="."+k.getAttribute("data-template-dlg");if("function"===typeof b.commonHub[p])b.commonHub[p](b,c,"create",null,function(g,k){"showNoteItemDlg"===p&&
!0===g&&(ctrlNote.listNotePosts.push({note:k}),b.refreshUI(ctrlNote.listNotePosts))});else if("function"===typeof b[p])b[p]();return!1}catch(a){return console.log("ERROR(NoteHub.onNoteMainMenu_Click()): "+a),!1}}function c(g){try{g.preventDefault();var k=getUserPerDataTemplate("note-list-view-item-template",g);b.noteData=ctrlNote.decodeNote(ctrlNote.getNoteById(k));if(!isDefine(b.noteData))return!1;var p=g.target,c=p.getAttribute("data-action"),a="."+p.getAttribute("data-template-dlg");u(c,a);return!1}catch(h){return console.log("ERROR(NoteHub.onUserAction_Click()): "+
h),!1}}function a(g){try{g.preventDefault();var k=getUserPerDataTemplate("note-list-view-item-template",g);try{b.noteData=ctrlNote.decodeNote(ctrlNote.getNoteById(k));try{b.showNoteDlg.find(".th-dlg-show-note-title").text(decodeURIComponent(b.noteData.title));b.showNoteDlg.find(".th-dlg-show-note-tags").text(decodeURIComponent(b.noteData.tags));b.showNoteDlg.find(".th-dlg-show-note-status").text(decodeURIComponent(b.noteData.status));var c;var a=decodeURIComponent(b.noteData.msg);try{var f=RegExp("<b>",
"g"),a=a.replace(f,'<span class="th-bold">'),f=RegExp("</b>","g"),a=a.replace(f,"</span>");g=0;for(k=null;-1<g;)k=h(a,"<link>","</link>",0),g=k.indexLast,isDefine(k.nodeValue)&&(a=a.replace("<link>","<a class='th-note-show-dlg-link' href='"+k.nodeValue+"'>"),a=a.replace("</link>","</a>"));for(g=0;-1<g;)k=h(a,"<pic>","</pic>",0),g=k.indexLast,isDefine(k.nodeValue)&&(a=a.replace("<pic>","<br><img class='th-note-show-dlg-img' src='"+k.nodeValue+"'>"),a=a.replace("</pic>","<br>"));c=a=a.replace(/\n/g,
"<br>")}catch(d){console.log("ERROR(NoticeHub.htmlFormatting())"+d),c=""}b.showNoteDlg.find(".th-dlg-show-note-content").empty().append("<span>"+c+"</span>")}catch(e){console.log("ERROR(NoteHub.bindDataShowDlg())"+e)}var q=b.commonHub.getHubZIndex(b);b.showNoteDlg.find(".th-dlg").css("z-index",q+1);b.showNoteDlg.removeClass("invisible-item")}catch(m){console.log("NoteHub.showNoticeDlg(): "+m)}return!1}catch(l){return console.log("ERROR(NoteHub.onItemNote_Click()): "+l),!1}}function d(g){try{g.preventDefault();
var k=g.target.getAttribute("data-action");if("link"===k)e("<link>","</link>");else if("bold"===k)e("<b>","</b>");else if("pic"===k)e("<pic>","</pic>");else if("web"===k)try{var a=f(".th-dlg-note-item textarea.th-dlg-note-item-text");isDefine(b.posFormatting)||(b.posFormatting=getCaret(a[0]));isDefine(b.posFormatting)||(b.posFormatting={},b.posFormatting.posStart=0,b.posFormatting.posEnd=0);b.posFormatting.posStart=b.posFormatting.posEnd;var c=a.val(),h=""!==document.title?"\n<b>"+document.title+
"</b>":"",d=getMetaContent("description"),q=h+(""!==d?"\n"+d:"")+("\n<link>"+document.URL+"</link>\n"),m=c.substr(0,b.posFormatting.posStart)+q+c.substr(b.posFormatting.posStart);a.val(m);b.posFormatting=null;b.noteChanged=!0;a.focus();a[0].setSelectionRange(a.val().length,0)}catch(l){console.log("ERROR(NoteHub.addWebInfoFormatting()): "+l)}return!1}catch(n){return console.log("ERROR(NoteHub.onFormatting_Click()): "+n),!1}}function e(g,a){try{var c=f(".th-dlg-note-item textarea.th-dlg-note-item-text");
isDefine(b.posFormatting)||(b.posFormatting=getCaret(c[0]));if(isDefine(b.posFormatting)&&!(0>b.posFormatting.posStart)){var h=c.val();if(b.posFormatting.posStart!==b.posFormatting.posEnd){var d=h.substr(0,b.posFormatting.posEnd)+a+h.substr(b.posFormatting.posEnd),e=d.substr(0,b.posFormatting.posStart)+g+d.substr(b.posFormatting.posStart);c.val(e)}else{var q=h.substr(0,b.posFormatting.posStart)+g+a+h.substr(b.posFormatting.posStart);c.val(q);var m=b.posFormatting.posStart+g.length;setCursor(c[0],
m,m)}b.posFormatting=null;b.noteChanged=!0}}catch(l){console.log("ERROR(NoteHub.addFormatting()): "+l)}}function h(b,a,c,h){try{var d=b.indexOf(a,h);if(-1<d){var f=b.indexOf(c,d+a.length);if(-1<f)return{nodeValue:b.substring(d+a.length,f),indexFirst:d,indexLast:f}}return{nodeValue:null,indexFirst:-1,indexLast:-1}}catch(e){return console.log("ERROR(NoticeHub.getNodeValueByPos())"+e),{nodeValue:null,indexFirst:-1,indexLast:-1}}}function q(a){try{return a.preventDefault(),b.showNoteDlg.hasClass("invisible-item")||
(b.showNoteDlg.addClass("invisible-item"),b.noteData=null),!1}catch(c){return console.log("NoteHub.onCloseAddNoticeDlg_Click(): "+c),!1}}function s(){try{b.showNoteDlg=f("#th-dlg-template-show-note"),f(document).on("click","#th-dlg-template-show-note .th-dlg-show-note .btn-circle",q),f(document).on("click",".th-dlg-note-item .th-formatting-tools-list li",d),f(document).on("keyup click",".th-dlg-note-item textarea.th-dlg-note-item-text",function(a){b.posFormatting=getCaret(this)}),f("#btn-input-search-notes").click(m),
f("#input-search-notes").keyup(function(b){13===b.keyCode&&m(b)}),f(document).on("click",".note-hub .th-user-actions li span",c),f(document).on("click","#note-list-view-ctrl li .template-text span",a),f(document).on("click",".note-hub ul.th-ul-main-menu li",l),f(document).on("mouseenter","#note-list-view-ctrl li",function(b){f(this).find(".th-user-actions").css("opacity","1.0")}),f(document).on("mouseleave","#note-list-view-ctrl li",function(b){f(this).find(".th-user-actions").css("opacity","0.0")}),
f(window).bind("beforeunload",function(a){if(b.noteChanged)return"HEY SAVE YOUR NOTE FIRST ?"})}catch(g){console.log("ERROR(NoteHub.setUIEvents()): "+g)}}function u(a,c){try{if("function"===typeof b.commonHub[a])b.commonHub[a](b,c,"edit",b.noteData,function(c,k){if("showNoteItemDlg"===a&&!0===c){var h=ctrlNote.getNoteIndexById(k.id);ctrlNote.listNotePosts[h].note=k;b.refreshUI(ctrlNote.listNotePosts)}});else if("function"===typeof b[a]&&("removeNote"!==a||!0===confirm("Are you sure you want delete this Note?")))b[a](event)}catch(h){console.log("ERROR(NoteHub.contexMenuAction()): "+
h)}}function v(b){try{for(var a="<b> </b> <pic> </pic> <link> </link>".split(" "),c=0;c<a.length;c++)b=b.replace(RegExp(a[c],"g"),"");return b}catch(h){console.log("ERROR(NoteHub.removeCommandCharacters())"+h)}}function w(a,c){try{if(isDefine(c)){if(!b.noteTemplate){var h=f("#note-item-template").html();b.noteTemplate=f(h)}if(0!==b.noteTemplate.length){var d=c.note,e=ctrlNote.decodeNote(d),q=JSON.stringify(d.id);f(b.noteTemplate).find(".template-data span").text(q);f(b.noteTemplate).find(".template-date span").text(d.date);
f(b.noteTemplate).find(".template-title span").text(60<=e.title.length?e.title.slice(0,57)+"...":e.title);var m=f(b.noteTemplate).find(".template-text span");if(""===e.msg)m.closest("div").css("margin-top","0"),m.text("");else{var l=v(JSON.parse(JSON.stringify(e.msg)));v(cloneObject(e.msg));m.text(90<=l.length?l.slice(0,87)+"...":l)}var n=f(b.noteTemplate).find(".template-pic img");""===e.pic?n.css("display","none"):n.attr("src",e.pic);var s=b.noteTemplate[0].outerHTML;f("#note-list-view-ctrl").last().append("<li>"+
s+"</li>");n[0].removeAttribute("style")}}}catch(u){console.log("ERROR(NoteHub.bindDataTemplateValues())"+u)}}var b,n=r.prototype;n.Initialize=function(){try{isDefine(ctrlNote)||(ctrlNote=new th.next.NoteController),b.commonHub.removeMainMenuItem(b,"note"),this.initHub(),b.commonHub.setHubPosition(b),b.hubStatus=statusHub.initialized,setTimeout(function(){b.readAllNotes()},600),s()}catch(a){console.log("ERROR(NoteHub.Initialize())"+a)}};n.readAllNotes=function(){try{var a=getUser();isDefine(a)&&(b.showProgressBar(!0),
f("#note-list-view-ctrl li").remove(),ctrlNote.listNotePosts=[],ctrlNote.getNotes(a,function(a){b.showProgressBar(!1);if(isDefine(ctrlNote.listNotePosts))for(a=ctrlNote.listNotePosts.length-1;0<=a;a--)w(a,ctrlNote.listNotePosts[a])}))}catch(c){console.log("ERROR(NoteHub.readAllNotes())"+c)}};n.refreshUI=function(b){try{f("#note-list-view-ctrl li").remove();for(var a=b.length;0<=a;a--)w(a,b[a])}catch(c){console.log("ERROR(NoteHub.refreshUI())"+c)}};n.removeNote=function(a){try{f(a.target).closest(".note-list-view-item-template").remove(),
b.showProgressBar(!0),setTimeout(function(){ctrlNote.removeNote(b.noteData,function(){b.showProgressBar(!1)})},600)}catch(c){console.log("ERROR(NoteHub.removeNote()): "+c)}};n.expandItem=function(a){try{var c=f("#note-list-view-ctrl"),h=b.collapseCss?"removeClass":"addClass";c.find(".template-text")[h]("invisible-item");c.find(".template-pic")[h]("invisible-item");c.find(".template-link span")[h]("invisible-item");this.collapseCss=!this.collapseCss;var d=c.find("li");this.collapseCss?d.css("cursor",
"pointer"):d.css("cursor","default")}catch(e){console.log("ERROR(NoteHub.expandItem()): "+e)}};n.initHub=function(){b.commonHub.initHub(b)};n.onMainMenuAction_Click=function(a){b.commonHub.onMainMenuAction_Click(b,a)};n.fromHubToHub=function(a,c){b.commonHub.fromHubToHub(b,a,c)};n.hubShow=function(a){b.commonHub.hubShow(b,a);b.hubStatus=b.hubStatus<statusHub.active?statusHub.active:b.hubStatus};n.hubRemove=function(){b.commonHub.hubRemove.call(this)};n.showProgressBar=function(a){b.commonHub.showProgressBar(b,
a)};n.getHubStatus=function(a){return b.hubStatus};return r}(thJQ);
th.next.NoteController=function(f){function r(){m=this;this.listNotePosts=[];this.favIcon=null;this.Initialize()}var m,l=r.prototype;l.Initialize=function(){};l.getFavIcon=function(c){try{var a=function(a,c){""===a?sendCallBack(c(a)):f("<img>",{src:a,error:function(){sendCallBack(c(""))},load:function(){sendCallBack(c(a))}})},d=function(){var a="",a=getDomain();return a=-1<a.indexOf("http://www.")?encodeURI(removeLineBreaks(getDomain()+"/favicon.ico")):-1<a.indexOf("www.")?encodeURI(removeLineBreaks("http://"+
getDomain()+"/favicon.ico")):encodeURI(removeLineBreaks("http://www."+getDomain()+"/favicon.ico"))}();a(d,function(h){""===h?(d=getFaviconPage(),0>d.indexOf("http")&&(d="http://"+getDomain()+d),a(d,function(a){sendCallBack(c(a))})):sendCallBack(c(h))})}catch(e){console.log("ERROR(NoteController.getFavIcon())"+e)}};l.getNotes=function(c,a){try{if(!(0<m.listNotePosts.length)&&isDefine(c)){var d=JSON.stringify({dbcall:"db-get",dbcollection:"notes",dbrequest:{owner:c.id},dbreturn:{note:1}});ajaxCall(pathServer+
"get-n-last-notes","get-n-last-notes="+d,function(c,d,e){if(isJsonData(c)&&(c=JSON.parse(c),"object"===typeof c.param)){m.listNotePosts=c.param;sendCallBack(a(!0));return}sendCallBack(a(!1))},function(c,d,e){console.log("ERROR[NoteController.getNotes()]: "+e);sendCallBack(a(!1))})}}catch(e){console.log("ERROR(NoteController.getNotes())"+e)}};l.addNote=function(c,a,d){try{if(isDefine(c)){a.showProgressBar(!0);var e=m.encodeNote(c),f={dbcall:"db-add",dbcollection:"notes",dbrequest:{owner:getUser().id,
note:{id:GUID(),date:getCurrentDate(),title:e.title,msg:e.msg,status:e.status,pic:e.pic,tags:e.tags,comments:[]}}},l=JSON.stringify(f);ajaxCall(pathServer+"add-note","add-note="+l,function(a,c,d){},function(a,c,d){console.log("add new NOTE Fail... -"+d)});sendCallBack(d(!0,c));a.showProgressBar(!1)}}catch(s){console.log("ERROR(NoteController.addNote())"+s)}};l.removeNote=function(c,a){try{if(isDefine(c)){var d={dbcall:"db-remove",dbcollection:"notes",dbfind:{owner:getUser().id,"note.id":c.id}},e=
JSON.stringify(d);ajaxCall(pathServer+"remove-note","remove-note="+e,function(a,c,d){},function(a,c,d){})}sendCallBack(a())}catch(f){console.log("ERROR(NoteController.removeNote())"+f)}};l.updateNote=function(c,a,d){try{if(isDefine(c)){a.showProgressBar(!0);var e=m.encodeNote(c),f=JSON.stringify({dbcall:"db-update",dbcollection:"notes",dbfind:{"note.id":e.id},dbupdate:{$set:{"note.title":e.title,"note.msg":e.msg,"note.status":"","note.pic":"undefined"===e.pic?"":e.pic,"note.tags":"undefined"===e.tags?
"":e.tags}}});ajaxCall(pathServer+"update-note","update-note="+f,function(e,f,h){a.showProgressBar(!1);sendCallBack(d(!0,c))},function(e,f,h){a.showProgressBar(!1);sendCallBack(d(!1,c))})}}catch(l){console.log("ERROR(NoteController.updateNote())"+l)}};l.getNoteById=function(c){try{if(!isDefine(c))return null;for(var a=0;a<m.listNotePosts.length;a++){var d=m.listNotePosts[a].note;if(d.id===c)return d}return null}catch(e){return console.log("ERROR(NoteController.getNoteById()): "+e),null}};l.getNoteIndexById=
function(c){try{if(!isDefine(c))return-1;for(var a=0;a<m.listNotePosts.length;a++)if(m.listNotePosts[a].note.id===c)return a;return-1}catch(d){return console.log("ERROR(NoteController.getNoteIndexById()): "+d),-1}};l.encodeNote=function(c){try{if(isDefine(c)){var a={};a.msg=encodeURIComponent(encodeLineBreaks(c.msg));a.status=encodeURIComponent(encodeLineBreaks(c.status));a.tags=encodeURIComponent(encodeLineBreaks(c.tags));a.title=isDefine(c.title)?encodeURIComponent(encodeLineBreaks(c.title)):"";
a.pic=isDefine(c.pic)?encodeURIComponent(encodeLineBreaks(c.pic)):"";a.id=c.id;return a}}catch(d){console.log("ERROR(NoteController.encodeNote())"+d)}};l.decodeNote=function(c){try{if(isDefine(c)){var a={};a.msg=decodeURIComponent(decodeLineBreaks(c.msg));a.status=decodeURIComponent(decodeLineBreaks(c.status));a.tags=decodeURIComponent(decodeLineBreaks(c.tags));a.title=decodeURIComponent(decodeLineBreaks(c.title));a.pic=decodeURIComponent(decodeLineBreaks(c.pic));a.id=c.id;a.date=c.date;return a}}catch(d){console.log("ERROR(NoteController.decodeNote())"+
d)}};return r}(thJQ);
