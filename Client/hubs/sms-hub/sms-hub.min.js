var th=th||{};th.next=th.next||{};
th.next.SmsHub=function(b){function t(){a=this;this.cssClassHub=".sms-hub";this.hubStatus=statusHub.not_active;this.userPerClick=this.bubbleRight=this.bubbleLeft=this.msgTemplate=this.usrTemplate=this.menuRefresh=this.menuGoBack=null;this.indexActiveUser=-1;this.arraySmsUsers=[];this.feedbackClass=".sms-hub-dlg-feedback";this.commonHub=new th.next.CommonHub(this);this.Initialize()}function e(d){try{d.preventDefault();a.userPerClick=null;a.userPerClick=getUserPerDataTemplate("sms-list-view-item-template",d);
try{if(isDefine(a.msgTemplate)&&(-1<a.indexActiveUser&&(b("#messages-list-view-ctrl .messages-list-view-item-template .bubbledLeft").remove(),b("#messages-list-view-ctrl .messages-list-view-item-template .bubbledRight").remove()),a.indexActiveUser=r(),-1<a.indexActiveUser)){var c=a.arraySmsUsers[a.indexActiveUser];if(isDefine(c))for(c.signal&&(y(a.indexActiveUser,!1),ctrlSms||(ctrlSms=new th.next.SmsController),getUser().id!==c.receiver.id?ctrlSms.changeSmsReadingStatus(c.receiver,c.sender,!0):ctrlSms.changeSmsReadingStatus(c.sender,
c.receiver,!0),a.arraySmsUsers[a.indexActiveUser].signal=!1),d=0;d<c.messages.length;d++)w(c.messages[d])}}catch(h){console.log("ERROR(SmsHub.showMessagesPerUser()): "+h)}var f=a.userPerClick;try{var k=b(".sms-hub .user-profile-picture");a.commonHub.setUserIcon(k,f)}catch(g){console.log("ERROR(SmsHub.changeUserIcon()): "+g)}v(l.messagesPanel);return!1}catch(e){return console.log("ERROR(SmsHub.onUser_Click()): "+e),!1}}function m(d){try{d.preventDefault();var c=b("#id-sms-text"),h=c.val();if(1>h.length)return!1;
var f=null,k=getUser(),g=function(c,d,b){a.showProgressBar(!1);isJsonData(c)&&null!==f&&(f.message.sms=h,a.socketSendSmsNotification(f))},e=function(c,d,b){console.log("ERROR[talkHub->ctrlSms.sendSms()]: "+b);a.showProgressBar(!1)};ctrlSms||(ctrlSms=new th.next.SmsController);setTimeout(function(){c.val("");f=ctrlSms.addSms(k,a.userPerClick,h,g,e)},600);a.showProgressBar(!0);return!1}catch(l){return console.log("ERROR(SmsHub.onBtnSendMessage()): "+l),a.showProgressBar(!1),!1}}function n(a){a.preventDefault();
v(l.userPanel);return!1}function s(d){d.preventDefault();try{b("#users-sms-list-view-ctrl li").remove(),b("#users-sms-list-view-ctrl").append("<li>"+a.usrTemplate[0].outerHTML+"</li>"),-1<a.indexActiveUser&&(b("#messages-list-view-ctrl .messages-list-view-item-template .bubbledLeft").remove(),b("#messages-list-view-ctrl .messages-list-view-item-template .bubbledRight").remove())}catch(c){console.log("ERROR(SmsHub.cleanUsersPanel()): "+c)}a.readAllUsers(!0,function(a){});return!1}function r(){try{for(var d=
0;d<a.arraySmsUsers.length;d++)if(a.arraySmsUsers[d].userActiveId===a.userPerClick.id)return d;return-1}catch(c){return console.log("ERROR(SmsHub.getIndexActiveUser()): "+c),-1}}function p(){try{b(document).on("click",".sms-list-view-item-template",e),b("#id-sms-text").keyup(function(a){13===a.keyCode&&m(a)}),b("#id-btn-send-sms").click(m)}catch(a){console.log("ERROR(SmsHub.setUIEvents()): "+a)}}function q(d,c,b){try{var f=getUser();if(d.sender.id===f.id)for(c=0;c<a.arraySmsUsers.length;c++){if(d.receiver.id===
a.arraySmsUsers[c].userActiveId){z(c,d,!1,b);break}}else if(d.receiver.id===f.id)for(c=0;c<a.arraySmsUsers.length;c++)if(d.sender.id===a.arraySmsUsers[c].userActiveId){z(c,d,!0,b);break}}catch(k){console.log("ERROR(SmsHub.updateUIWithNewSms()): "+k)}}function z(d,c,b,f){try{f&&a.arraySmsUsers[d].messages.push(c.message),u===l.userPanel&&b?(a.arraySmsUsers[d].signal=!0,y(d,!0)):u===l.messagesPanel&&d===a.indexActiveUser&&w(c.message)}catch(k){console.log("ERROR(SmsHub.addNewSmsUI()): "+k)}}function x(d,
c){try{if(a.usrTemplate||(a.usrTemplate=b(".sms-list-view-item-template.template-item")),0!==a.usrTemplate.length){var h=c.receiver.id!==getUser().id?c.receiver:c.sender,f=c.receiver.id===getUser().id?c.receiver:c.sender;c.userActiveId=h.id;c.signal=!1;f.hasOwnProperty("sms_reading")&&(c.signal=!1===f.sms_reading?!0:!1);var k=JSON.stringify(h);b(a.usrTemplate).find(".template-data span").text(k);b(a.usrTemplate).find(".template-date span").text(c.date);var g=getStrUserShortProfile(h);b(a.usrTemplate).find(".template-nick span").text(h.nick);
var e=b(a.usrTemplate).find(".template-image");a.commonHub.setUserIcon(e,h);e[0].setAttribute("title",g);var l="<li>"+a.usrTemplate[0].outerHTML.replace("template-item","")+"</li>";b("#users-sms-list-view-ctrl").append(l);e[0].removeAttribute("style");c.signal&&y(d,!0)}}catch(m){console.log("ERROR(SmsHub.bindUsersDataTemplateValues()): "+m)}}function w(d){try{var c=getUser(),b=d.from===c.id?a.bubbleLeft:a.bubbleRight;b.find("span").text(d.sms);var f=b[0].outerHTML.replace("template-item","");a.msgTemplate.append(f);
var k=document.getElementById("messages-list-view-ctrl");k.scrollTop=k.scrollHeight}catch(e){console.log("ERROR(SmsHub.bindMessageDataTemplateValues()): "+e)}}function v(d){try{var c;u=d;var h=b(".sms-hub .user-profile-picture"),f=b(".sms-hub .th-article .th-title"),k=b(".sms-hub .th-article .sub-title");switch(u){case l.initialize:h.css("display","none");a.menuRefresh.css("display","block");a.menuGoBack.css("display","none");break;case l.userPanel:h.css("display","none");a.menuRefresh.css("display",
"block");a.menuGoBack.css("display","none");f.text("MESSAGES");k.text("Your messages from everyone");b(".users-list").css("display","block");b(".messages-list").css("display","none");break;case l.messagesPanel:h.css("display","block"),a.menuRefresh.css("display","none"),a.menuGoBack.css("display","block"),f.text(a.userPerClick.nick),k.text(getStrUserShortProfile(a.userPerClick)),b(".users-list").css("display","none"),b(".messages-list").css("display","block"),c=document.getElementById("messages-list-view-ctrl"),
c.scrollTop=c.scrollHeight}}catch(e){console.log("ERROR(SmsHub.changeUi()): "+e)}}function y(a,c){try{var e=b("#users-sms-list-view-ctrl li .sms-list-view-item-template")[a+1];c?b(e).find(".signal-item").css("display","block"):b(e).find(".signal-item").css("display","none")}catch(f){console.log("ERROR(showSignalForUser()): "+f)}}var a,g=t.prototype,l={initialize:0,userPanel:1,messagesPanel:2},u=l.initialize;g.Initialize=function(){try{a.commonHub.removeMainMenuItem(a,"sms");this.initHub();p();a.msgTemplate=
b(".messages-list-view-item-template");a.bubbleLeft=b(a.msgTemplate).find(".bubbledLeft.template-item");a.bubbleRight=b(a.msgTemplate).find(".bubbledRight.template-item");try{a.menuGoBack=b(".sms-hub ul.th-ul-main-menu li.li_shop"),b(document).on("click",a.menuGoBack.selector,n),a.menuRefresh=b(".sms-hub ul.th-ul-main-menu li.li_params"),b(document).on("click",a.menuRefresh.selector,s)}catch(d){console.log("ERROR(SmsHub.setMainMenu()): "+d)}v(l.initialize);a.commonHub.setHubPosition(a);a.hubStatus=
statusHub.initialized}catch(c){console.log("ERROR(SmsHub.initHub())"+c)}};g.socketSendSmsNotification=function(a){try{Socket.emit(socketEvents.socket_sms_notification,a)}catch(c){console.log("ERROR(SmsHub.socketSendSmsNotification()): "+c)}};g.socketSms_Notification_Completed=function(b,c){try{0===a.arraySmsUsers.length?a.readAllUsers(!0,function(a){a&&q(b,c,!1)}):q(b,c,!0)}catch(e){console.log("ERROR(SmsHub.socketSms_Notification_Completed()): "+e)}};g.readAllUsers=function(d,c){try{if(b("#users-sms-list-view-ctrl li div.sms-list-view-item-template"),
u!==l.messagesPanel&&(d||0===a.arraySmsUsers.length)){var e=getUser();isDefine(e)&&(ctrlSms||(ctrlSms=new th.next.SmsController),ctrlSms.getAllSmsUsers(e,function(d,e,f){a.hubStatus=statusHub.data_loaded;a.showProgressBar(!1);try{if(isJsonData(d)){var g=JSON.parse(d);a.indexActiveUser=-1;a.arraySmsUsers=[];if("object"===typeof g.param){a.arraySmsUsers=g.param;for(d=0;d<a.arraySmsUsers.length;d++)x(d,a.arraySmsUsers[d]);b(a.menuRefresh).removeClass("invisible-item");u=l.userPanel;sendCallBack(c(!0));
return}}a.commonHub.showInfoDlg(a,".sms-hub-dlg-info","You don't have any -sms- yet",function(a){});sendCallBack(c(!0))}catch(h){console.log("FAIL-PARSING[SmsHub->ctrlSms.getAllSmsUsers()]: "+h),a.hubStatus=statusHub.data_loaded_err,sendCallBack(c(!1))}},function(d,b,e){console.log("ERROR[SmsHub->ctrlSms.getAllSmsUsers()]: "+e);a.showProgressBar(!1);a.hubStatus=statusHub.data_loaded_err;sendCallBack(c(!1))}),a.showProgressBar(!0))}}catch(f){console.log("ERROR(SmsHub.readAllUsers()): "+f),a.showProgressBar(!1)}};
g.initHub=function(){a.commonHub.initHub(a)};g.onMainMenuAction_Click=function(d){a.commonHub.onMainMenuAction_Click(a,d)};g.fromHubToHub=function(d,c){a.commonHub.fromHubToHub(a,d,c)};g.hubShow=function(d){a.commonHub.hubShow(a,d);a.hubStatus=a.hubStatus<statusHub.active?statusHub.active:a.hubStatus};g.hubRemove=function(){a.commonHub.hubRemove.call(this)};g.showProgressBar=function(d){a.commonHub.showProgressBar(a,d)};g.getHubStatus=function(d){return a.hubStatus};g.getHubZIndex=function(){a.commonHub.getHubZIndex(a)};
g.isHubOnTop=function(){return a.commonHub.isHubOnTop(a)};return t}(thJQ);
th.next.SmsController=function(b){function t(){}b=t.prototype;b.getAllSmsUsers=function(b,m,n){try{if(isDefine(b)&&isDefine(m)&&isDefine(n)){var s=JSON.stringify({dbcall:"db-find",dbcollection:"messages",dbrequest:{$or:[{"receiver.id":b.id},{"sender.id":b.id}]}});ajaxCall(pathServer+"get-all-sms-users","get-all-sms-users="+s,m,n)}}catch(r){console.log("ERROR[SmsHub->SmsController.getAllSmsUsers()]: "+r)}};b.changeSmsReadingStatus=function(b,m,n){try{if(isDefine(b)&&isDefine(m)&&isDefine(n)){var s=
getUserProfile(b),r=getUserProfile(m),p=JSON.stringify({sender:s,receiver:r,status:n});ajaxCall(pathServer+"change-sms-reading-status","change-sms-reading-status="+p,function(b,e,m){},function(b,e,m){console.log("ERROR[SmsHub->ctrlSms.changeSmsReadingStatus()]")})}}catch(q){console.log("ERROR[SmsHub->SmsController.changeSmsReadingStatus()]: "+q)}};b.addSms=function(b,m,n,s,r){try{if(!(isDefine(b)&&isDefine(m)&&isDefine(n)&&isDefine(s)&&isDefine(r)))return null;var p=getUserProfile(b);isDefine(p.pic)&&
""!==p.pic&&(p.pic=encodeURIComponent(p.pic));var q=getUserProfile(m);isDefine(q.pic)&&""!==q.pic&&(q.pic=encodeURIComponent(q.pic));var t=encodeURIComponent(removeLineBreaks(n)),x={sender:p,receiver:q,date:getCurrentDate(),message:{from:p.id,sms:t,date:getCurrentDate()}},w=JSON.stringify(x);ajaxCall(pathServer+"add-sms","add-sms="+w,s,r);return x}catch(v){return console.log("ERROR[SmsController.addSms()]: "+v),null}};return t}(thJQ);
