th.next.PinHub=function(e){function m(){b=this;this.cssClassHub=".pin-hub";this.hubStatus=statusHub.not_active;this.pinTemplate=this.userPerClick=null;this.searchResults=[];this.collapseCss=!1;this.feedbackClass=".pin-hub-dlg-feedback";this.commonHub=new th.next.CommonHub(this);this.Initialize()}function n(g){try{g.preventDefault();if(0===ctrlPin.listPins.length)return!1;var a=e("#input-search-pins").val().toLowerCase();if(!isDefine(a)||""===a)return!1;b.showProgressBar(!0);b.collapseCss=!1;a:try{var p=
a.split(/,| /);for(g=0;g<p.length;g++)""===p[g]&&p.splice(g,1);b.searchResults=null;b.searchResults=[];for(g=0;g<p.length;g++){var f=p[g];if(""===f)break a;for(a=0;a<ctrlPin.listPins.length;a++){var c=ctrlPin.listPins[a];if(-1<c.post.title.toLowerCase().indexOf(f)||-1<c.post.msg.toLowerCase().indexOf(f)||-1<c.post.tags.toLowerCase().indexOf(f)){for(var d=!1,k=0;k<b.searchResults.length;k++)if(b.searchResults[k].post.id===c.post.id){d=!0;break}d||b.searchResults.push(c)}}}0<b.searchResults.length&&
b.refreshUI(b.searchResults)}catch(h){console.log("ERROR(PinHub.searchRoutine()): "+h)}b.showProgressBar(!1);return!1}catch(l){return console.log("ERROR(PinHub.onSearch_Click()): "+l),!1}}function r(a){try{a.preventDefault();var q=a.target,c=q.getAttribute("data-action"),f="."+q.getAttribute("data-template-dlg");if("function"===typeof b.commonHub[c])b.commonHub[c](b,f,"create",null,function(a,g){"showPinItemDlg"===c&&!1===a&&(ctrlPin.listPins.push({post:g}),b.refreshUI(ctrlPin.listPins))});else if("function"===
typeof b[c])b[c]();return!1}catch(d){return console.log("PinHub.onPinMainMenu_Click(): "+d),!1}}function h(a){try{a.preventDefault();var q=getUserPerDataTemplate("pin-list-view-item-template",a);b.pinData=ctrlPin.getPinById(q);if(isDefine(b.pinData)){var c=a.target,f=c.getAttribute("data-action"),d="."+c.getAttribute("data-template-dlg");if("function"===typeof b.commonHub[f])b.commonHub[f](b,d,"edit",b.pinData,function(a,g){if("showPinItemDlg"===f&&!1===a){var c=ctrlPin.getPinById(g.id);c.title=g.title;
c.msg=g.msg;c.tags=g.tags;c.link=g.link;c.pic=g.pic;b.refreshUI(ctrlPin.listPins)}});else if("function"===typeof b[f])b[f](a);return!1}}catch(e){return console.log("ERROR(PinHub.onUserAction_Click()): "+e),!1}}function l(a){try{a.preventDefault();var c=e(a.target).closest(".pin-list-view-item-template");if(b.collapseCss){var d=c.find(".template-text").hasClass("invisible-item")?"removeClass":"addClass";c.find(".template-text")[d]("invisible-item");c.find(".template-pic")[d]("invisible-item");c.find(".template-link span")[d]("invisible-item")}return!1}catch(f){return console.log("ERROR(PinHub.onItemPin_Click()): "+
f),!1}}function a(a){try{a.preventDefault();var b=e(this).attr("href");window.open(b);return!1}catch(c){return console.log("ERROR(PinHub.onItemPinLink_Click()): "+c),!1}}function d(){try{e(document).on("click",".pin-hub #pin-list-view-ctrl li .template-link a",a),e("#btn-input-search-pins").click(n),e("#input-search-pins").keyup(function(a){13===a.keyCode&&n(a)}),e(document).on("click",".pin-hub .th-user-actions li span",h),e(document).on("click",".pin-hub #pin-list-view-ctrl li",l),e(document).on("click",
".pin-hub ul.th-ul-main-menu li",r),e(document).on("mouseenter","#pin-list-view-ctrl li",function(a){e(this).find(".th-user-actions").css("opacity","1.0")}),e(document).on("mouseleave","#pin-list-view-ctrl li",function(a){e(this).find(".th-user-actions").css("opacity","0.0")})}catch(b){console.log("ERROR(PinHub.setUIEvents()): "+b)}}function k(a,c){try{if(isDefine(c)){if(!b.pinTemplate){var d=e("#pin-item-template").html();b.pinTemplate=e(d)}if(0!==b.pinTemplate.length){var f=c.post,k=JSON.stringify(c.post.id);
e(b.pinTemplate).find(".template-data span").text(k);e(b.pinTemplate).find(".template-date span").text(f.date);e(b.pinTemplate).find(".template-title span").text(60<=f.title.length?f.title.slice(0,57)+"...":f.title);var h=e(b.pinTemplate).find(".template-text span");""===f.msg?(h.closest("div").css("margin-top","0"),h.text("")):(h.text(255<=f.msg.length?f.msg.slice(0,252)+"...":f.msg),h.closest("div").css("margin-top","15px"));e(b.pinTemplate).find(".template-link a").text(90<=f.link.length?f.link.slice(0,
87)+"...":f.link);e(b.pinTemplate).find(".template-link a").attr("href",f.link);var l=e(b.pinTemplate).find(".template-pic img");""===f.pic?l.css("display","none"):l.attr("src",f.pic);e(b.pinTemplate).find(".template-favicon img").attr("src",f.ico);var m=b.pinTemplate[0].outerHTML;e("#pin-list-view-ctrl").last().append("<li>"+m+"</li>");l[0].removeAttribute("style")}}}catch(n){console.log("ERROR(PinHub.bindDataTemplateValues())"+n)}}var b,c=m.prototype;c.Initialize=function(){try{isDefine(ctrlPin)||
(ctrlPin=new th.next.PinController),b.commonHub.removeMainMenuItem(b,"pin"),this.initHub(),b.commonHub.setHubPosition(b),b.hubStatus=statusHub.initialized,setTimeout(function(){b.readAllPins()},600),d()}catch(a){console.log("ERROR(PinHub.Initialize())"+a)}};c.readAllPins=function(){try{var a=getUser();isDefine(a)&&(b.showProgressBar(!0),e("#pin-list-view-ctrl li").remove(),ctrlPin.listPins=[],ctrlPin.getFavIcon(function(c){isDefine(c)&&""!==c?ctrlPin.favIcon=c:ctrlPin.favIcon="http://typehello.com/favicon.ico";
ctrlPin.getPins(a,function(a){b.showProgressBar(!1);if(isDefine(ctrlPin.listPins))for(a=ctrlPin.listPins.length-1;0<=a;a--)k(a,ctrlPin.listPins[a])})}))}catch(c){console.log("ERROR(PinHub.readAllPins())"+c)}};c.refreshUI=function(a){try{e("#pin-list-view-ctrl li").remove();for(var b=a.length;0<=b;b--)k(b,a[b])}catch(c){console.log("ERROR(PinHub.refreshUI())"+c)}};c.removePin=function(a){try{e(a.target).closest(".pin-list-view-item-template").remove();var c=b.pinData;b.showProgressBar(!0);setTimeout(function(){ctrlPin.removePin(b.pinData,
function(){var a=ctrlPin.getPinIndexById(c.id);ctrlPin.listPins.splice(a,1);b.showProgressBar(!1)})},600)}catch(d){console.log("ERROR(PinHub.removePin()): "+d),b.showProgressBar(!1)}};c.expandItem=function(a){try{var c=e("#pin-list-view-ctrl"),d=b.collapseCss?"removeClass":"addClass";c.find(".template-text")[d]("invisible-item");c.find(".template-pic")[d]("invisible-item");c.find(".template-link span")[d]("invisible-item");this.collapseCss=!this.collapseCss;var f=c.find("li");this.collapseCss?f.css("cursor",
"pointer"):f.css("cursor","default")}catch(k){console.log("ERROR(PinHub.expandItem()): "+k)}};c.initHub=function(){b.commonHub.initHub(b)};c.onMainMenuAction_Click=function(a){b.commonHub.onMainMenuAction_Click(b,a)};c.fromHubToHub=function(a,c){b.commonHub.fromHubToHub(b,a,c)};c.hubShow=function(a){b.commonHub.hubShow(b,a);b.hubStatus=b.hubStatus<statusHub.active?statusHub.active:b.hubStatus};c.hubRemove=function(){b.commonHub.hubRemove.call(this)};c.showProgressBar=function(a){b.commonHub.showProgressBar(b,
a)};c.getHubStatus=function(a){return b.hubStatus};return m}(thJQ);
th.next.PinController=function(e){function m(){h=this;this.listPins=[];this.favIcon=null;this.Initialize()}function n(a){try{a.msg=decodeURIComponent(a.msg),a.tags=decodeURIComponent(a.tags),a.title=decodeURIComponent(a.title),a.link=decodeURIComponent(a.link),a.pic=decodeURIComponent(a.pic)}catch(d){console.log("ERROR(PinController.decodePin())"+d)}}function r(a){try{a.msg=encodeURIComponent(removeLineBreaks(a.msg)),a.tags=encodeURIComponent(removeLineBreaks(a.tags)),a.title=isDefine(a.title)?encodeURIComponent(removeLineBreaks(a.title)):
"",a.link=isDefine(a.link)?encodeURI(removeLineBreaks(a.link)):"",a.pic=isDefine(a.pic)?encodeURI(removeLineBreaks(a.pic)):""}catch(d){console.log("ERROR(PinController.encodePin())"+d)}}var h,l=m.prototype;l.Initialize=function(){};l.getFavIcon=function(a){try{var d=function(a,b){try{""===a?sendCallBack(b(a)):e("<img>",{src:a,error:function(){sendCallBack(b(""))},load:function(){sendCallBack(b(a))}})}catch(d){console.log("ERROR(PinController.getFavIcon.checkIconUrl())"+d)}},k=function(){try{var a=
"",b=getDomain();return a=-1<b.indexOf("http://www.")?encodeURI(removeLineBreaks(b+"/favicon.ico")):-1<b.indexOf("www.")?encodeURI(removeLineBreaks("http://"+b+"/favicon.ico")):encodeURI(removeLineBreaks("http://www."+b+"/favicon.ico"))}catch(d){return console.log("ERROR(PinController.getFavIcon.getFavIconUrlByDomain())"+d),null}}();d(k,function(b){""===b?(k=getFaviconPage(),0>k.indexOf("http")&&(k="http://"+getDomain()+k),d(k,function(b){sendCallBack(a(b))})):sendCallBack(a(b))})}catch(b){console.log("ERROR(PinController.getFavIcon())"+
b)}};l.getPins=function(a,d){try{if(!(0<h.listPins.length)&&isDefine(a)){var e=JSON.stringify({dbcall:"db-get",dbcollection:"pin",dbrequest:{owner:a.id},dbreturn:{post:1}});ajaxCall(pathServer+"get-n-last-pin-posts","get-n-last-pin-posts="+e,function(a,b,e){if(isJsonData(a)&&(a=JSON.parse(a),"object"===typeof a.param)){h.listPins=a.param;sendCallBack(d(!0));return}sendCallBack(d(!1))},function(a,b,e){console.log("ERROR[PinController.getPins()]: "+e);sendCallBack(d(!1))})}}catch(b){console.log("ERROR(PinController.getPins())"+
b)}};l.addPin=function(a,d){try{if(isDefine(a)){r(a);a.ico=h.favIcon;var e={dbcall:"db-add",dbcollection:"pin",dbrequest:{owner:getUser().id,post:{id:GUID(),date:getCurrentDate(),title:a.title,msg:a.msg,link:a.link,pic:a.pic,tags:a.tags,ico:a.ico,comments:[]}}},b=JSON.stringify(e);ajaxCall(pathServer+"add-pin-post","add-pin-post="+b,function(a,b,c){},function(a,b,c){});n(e.dbrequest.post);sendCallBack(d(!1,e.dbrequest.post))}}catch(c){console.log("ERROR(PinController.addPin())"+c)}};l.removePin=function(a,
d){try{isDefine(a)||sendCallBack(d());var e={dbcall:"db-remove",dbcollection:"pin",dbfind:{owner:getUser().id,"post.id":a.id}},b=JSON.stringify(e);ajaxCall(pathServer+"remove-pin-post","remove-pin-post="+b,function(a,b,c){},function(a,b,c){});sendCallBack(d())}catch(c){console.log("ERROR(PinController.removePin())"+c)}};l.updatePin=function(a,d){try{if(isDefine(a)){r(a);var e={dbcall:"db-update",dbcollection:"pin",dbfind:{owner:getUser().id,"post.id":a.id},dbupdate:{$set:{"post.title":a.title,"post.msg":a.msg,
"post.link":a.link,"post.pic":a.pic,"post.tags":a.tags}}},b=JSON.stringify(e);ajaxCall(pathServer+"update-pin-post","update-pin-post="+b,function(a,b,c){},function(a,b,c){});n(a);sendCallBack(d(!1,a))}}catch(c){console.log("ERROR(PinController.updatePin())"+c)}};l.getPinById=function(a){try{if(!isDefine(a))return null;for(var d=0;d<h.listPins.length;d++){var e=h.listPins[d].post;if(e.id===a)return e}return null}catch(b){return console.log("ERROR(PinController.getPinById()): "+b),null}};l.getPinIndexById=
function(a){try{if(!isDefine(a))return-1;for(var d=0;d<h.listPins.length;d++)if(h.listPins[d].post.id===a)return d;return-1}catch(e){return console.log("ERROR(PinController.getPinIndexById()): "+e),-1}};return m}(thJQ);
