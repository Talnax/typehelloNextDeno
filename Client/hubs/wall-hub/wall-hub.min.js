th.next.WallHub=function(a){function m(){b=this;this.cssClassHub=".wall-hub";this.hubStatus=statusHub.not_active;this.wallCommentTemplate=this.wallTemplate=this.userPerClick=null;this.feedbackClass=".wall-hub-dlg-feedback";this.commonHub=new th.next.CommonHub(this);this.Initialize()}function n(k){try{k.preventDefault();var a=k.target,c=a.getAttribute("data-action"),d="."+a.getAttribute("data-template-dlg");if("function"===typeof b.commonHub[c])b.commonHub[c](b,d,function(k,a){"showWallItemDlg"===
c&&!0===k&&(ctrlWall.listWallPosts.push({post:a}),b.refreshUI())});else if("function"===typeof b[c])b[c]();return!1}catch(e){return console.log("WallHub.onTalkMainMenu_Click(): "+e),!1}}function q(k){try{k.preventDefault();b.userPerClick=getUserPerDataTemplate("wall-list-view-item-template",k);b.postData=ctrlWall.getPostById(b.userPerClick.post_id);var a=k.target,c=a.getAttribute("data-action"),d="."+a.getAttribute("data-template-dlg");if("function"===typeof b.commonHub[c])b.commonHub[c](b,d,function(k,
a){if("showSubPostWallItemDlg"===c&&!0===k)for(var d=0;d<ctrlWall.listWallPosts.length;d++){var s=ctrlWall.listWallPosts[d].post;if(s.id===a.post_id){s.comments.push(a.comment);b.refreshUI();break}}});else if("function"===typeof b[c])b[c](k);return!1}catch(e){return console.log("ERROR(WallHub.onUserAction_Click()): "+e),!1}}function l(b){try{b.preventDefault();var c=a(this).attr("href");window.open(c);return!1}catch(d){return console.log("ERROR(PinHub.onItemPostLink_Click()): "+d),!1}}function c(){try{a(document).on("click",
".wall-hub #wall-list-view-ctrl li .template-link a",l),a(document).on("click",".wall-hub .th-user-actions li",q),a(document).on("click",".wall-hub ul.th-ul-main-menu li",n),a(document).on("mouseenter","#wall-list-view-ctrl li",function(b){a(this).find(".th-user-actions").css("opacity","1.0")}),a(document).on("mouseleave","#wall-list-view-ctrl li",function(b){a(this).find(".th-user-actions").css("opacity","0.0")})}catch(b){console.log("ERROR(WallHub.setUIEvents()): "+b)}}function e(b){try{var a=getUser();
b.hasOwnProperty("not_show_for")?0>b.not_show_for.indexOf(a.id)&&b.not_show_for.push(a.id):(b.not_show_for=[],b.not_show_for.push(a.id))}catch(c){console.log("ERROR(WallHub.getPostById())"+c)}}function f(){try{var c=getUser().id;if(isDefine(ctrlWall.listWallPosts))for(var d=ctrlWall.listWallPosts.length-1;0<=d;d--){var e=ctrlWall.listWallPosts[d].post;if(!(e.hasOwnProperty("not_show_for")&&-1<e.not_show_for.indexOf(c)))a:{var f=ctrlWall.listWallPosts[d];try{if(isDefine(f)){if(!isDefine(b.wallTemplate)){var g=
a("#wall-item-template").html();b.wallTemplate=a(g);if(!isDefine(b.wallTemplate)||0===b.wallTemplate.length)break a}var h=f.post;h.sender.post_id=f.post.id;var l=JSON.stringify(h.sender);a(b.wallTemplate).find(".template-data span").text(l);a(b.wallTemplate).find(".template-date span").text(h.date);a(b.wallTemplate).find(".template-nick span").text(h.sender.nick);a(b.wallTemplate).find(".template-title span").text(60<=h.title.length?h.title.slice(0,57)+"...":h.title);a(b.wallTemplate).find(".template-text span").text(255<=
h.msg.length?h.msg.slice(0,252)+"...":h.msg);a(b.wallTemplate).find(".template-link a").text(90<=h.link.length?h.link.slice(0,87)+"...":h.link);a(b.wallTemplate).find(".template-link a").attr("href",h.link);var r=a(b.wallTemplate).find(".template-pic img");""===h.pic?(r.attr("src",""),r.css("margin-top","0"),r.css("margin-bottom","0"),r.css("visibility","hidden")):r.attr("src",h.pic);var m=a(b.wallTemplate).find(".template-image");b.commonHub.setUserIcon(m,h.sender);var q=b.wallTemplate[0].outerHTML;
a("#wall-list-view-ctrl").last().append("<li>"+q+"</li>");m[0].removeAttribute("style");r[0].removeAttribute("style");for(var n=0;n<h.comments.length;n++){var p=h.comments[n];try{if(!b.wallCommentTemplate){var u=a("#wall-item-comment-template").html();b.wallCommentTemplate=a(u)}if(0!==b.wallCommentTemplate.length){p.sender.post_id=p.id;var v=JSON.stringify(p.sender);a(b.wallCommentTemplate).find(".template-data span").text(v);a(b.wallCommentTemplate).find(".template-date span").text(p.date);a(b.wallCommentTemplate).find(".template-nick span").text(p.sender.nick);
a(b.wallCommentTemplate).find(".template-text span").text(p.msg);var t=a(b.wallCommentTemplate).find(".template-image");b.commonHub.setUserIcon(t,p.sender);var w=b.wallCommentTemplate[0].outerHTML;a(".wall-list-view-comments-ctrl").last().append("<li>"+w+"</li>");t[0].removeAttribute("style")}}catch(x){console.log("ERROR(WallHub.bindDataTemplateValues())"+x)}}}}catch(y){console.log("ERROR(WallHub.bindDataTemplateValues())"+y)}}}}catch(z){console.log("ERROR(WallHub.updateUIPost())"+z)}}function g(){try{var c=
parseInt(a(b.cssClassHub).css("width"));a(b.cssClassHub).css("left",parseInt(window.innerWidth-c-18)+"px")}catch(d){console.log("ERROR(WallHub.rePositionHub())"+d)}}var b,d=m.prototype;d.Initialize=function(){try{b.commonHub.removeMainMenuItem(b,"wall"),this.initHub(),b.commonHub.setHubPosition(b),setTimeout(function(){b.readAllWallPosts()},600),g(),c(),b.hubStatus=statusHub.initialized}catch(a){console.log("ERROR(WallHub.Initialize())"+a)}};d.readAllWallPosts=function(){try{var c=getUser();isDefine(c)&&
(isDefine(ctrlWall)||(ctrlWall=new th.next.WallController),b.showProgressBar(!0),a("#wall-list-view-ctrl li").remove(),ctrlWall.listWallPosts=[],ctrlWall.getWallPosts(c,function(a){b.showProgressBar(!1);f()}))}catch(d){console.log("ERROR(WallHub.readAllWallPosts())"+d)}};d.refreshUI=function(){try{a("#wall-list-view-ctrl li").remove(),f()}catch(b){console.log("ERROR(WallHub.refreshUI())"+b)}};d.removePost=function(c){try{a(c.target).closest(".wall-list-view-item-template").remove(),e(b.postData),
b.showProgressBar(!0),setTimeout(function(){ctrlWall.removeWallPost(getUser(),b.postData,function(){b.showProgressBar(!1)})},600)}catch(d){console.log("ERROR(PinHub.removePin()): "+d)}};d.initHub=function(){b.commonHub.initHub(b)};d.onMainMenuAction_Click=function(a){b.commonHub.onMainMenuAction_Click(b,a)};d.fromHubToHub=function(a,c){b.commonHub.fromHubToHub(b,a,c)};d.hubShow=function(a){b.commonHub.hubShow(b,a);b.hubStatus=b.hubStatus<statusHub.active?statusHub.active:b.hubStatus};d.hubRemove=
function(){b.commonHub.hubRemove.call(this)};d.showProgressBar=function(a){b.commonHub.showProgressBar(b,a)};d.getHubStatus=function(a){return b.hubStatus};return m}(thJQ);
th.next.WallController=function(a){function m(){l=this;this.listWallPosts=[];this.Initialize()}function n(a,e){try{this.post=a,loadHub("person-hub",function(a){"ok"===a&&(ctrlPerson||(ctrlPerson=new th.next.PersonController),ctrlPerson.getPersons(getUser(),function(){var b=[];if(null!==ctrlPerson.listPerson)for(var a=0;a<ctrlPerson.listPerson.length;a++){var c=ctrlPerson.listPerson[a],f=!1,g=!1;if(""===c.person.language||"any language"===this.post.language.toLowerCase()||this.post.language.toLowerCase()===
c.person.language.toLowerCase())f=!0;if("all"===this.post.status.toLowerCase()||this.post.status.toLowerCase()===c.status)g=!0;f&&g&&b.push(ctrlPerson.listPerson[a].person.id)}sendCallBack(e(b))}))})}catch(f){console.log("ERROR(WallController.getFriends())"+f)}}function q(a){try{a.msg=decodeURIComponent(a.msg),a.title=decodeURIComponent(a.title),a.link=decodeURIComponent(a.link),a.pic=decodeURIComponent(a.pic)}catch(e){console.log("ERROR(WallController.decodePost())"+e)}}var l;a=m.prototype;a.Initialize=
function(){};a.getWallPosts=function(a,e){try{if(!(0<l.listWallPosts.length)&&isDefine(a)){var f=JSON.stringify({dbcall:"db-add",dbcollection:"wall",dbrequest:{receivers:a.id},dbreturn:{post:1},dblimit:{limit:18}});ajaxCall(pathServer+"get-n-last-wall-posts","get-n-last-wall-posts="+f,function(b,a,c){if(isJsonData(b)&&(b=JSON.parse(b),"object"===typeof b.param)){l.listWallPosts=b.param;sendCallBack(e(!0));return}sendCallBack(e(!1))},function(b,a,c){console.log("ERROR[WallController.getAllWallItems()]: "+
c);sendCallBack(e(!1))})}}catch(g){console.log("ERROR(WallController.getAllWallItems())"+g)}};a.addWallPost=function(a,e,f){try{e.showProgressBar(!0),_message=encodeURIComponent(removeLineBreaks(a.msg)),_title=isDefine(a.title)?encodeURIComponent(removeLineBreaks(a.title)):"",_link=isDefine(a.link)?encodeURIComponent(removeLineBreaks(a.link)):"",_img=isDefine(a.img)?encodeURIComponent(removeLineBreaks(a.img)):"",n(a,function(b){var a=[];0<b.length&&(a=b.slice(0));a.push(getUser().id);var c={dbcall:"db-add",
dbcollection:"wall",dbrequest:{receivers:a,post:{id:GUID(),sender:getUserId(getUser()),date:getCurrentDate(),title:_title,msg:_message,link:_link,pic:_img,comments:[]}}},g="";""!=_link&&(g="<br> Link to content of post: "+_link);var l=JSON.stringify(c);ajaxCall(pathServer+"add-wall-post","add-wall-post="+l,function(c,e,f){1>b.length||sendMailToUsersID(getUser(),a,"TypeHello notification"," send new post on Wall."+g,mailNotificationType.wall,mailContentType.html,function(){})},function(a,b,c){});q(c.dbrequest.post);
sendCallBack(f(!0,c.dbrequest.post));e.showProgressBar(!1)})}catch(g){console.log("ERROR(WallController.addWallPostRoutine())"+g)}};a.addWallSubPost=function(a,e,f){try{if(isDefine(a)){a=encodeURIComponent(removeLineBreaks(a));var g={post_id:e.userPerClick.post_id,comment:{id:GUID(),sender:getUserId(getUser()),date:getCurrentDate(),title:"",msg:a,link:""}};e.showProgressBar(!0);var b=JSON.stringify(g);setTimeout(function(){ajaxCall(pathServer+"add-wall-sub-post","add-wall-sub-post="+b,function(a,
b,c){},function(a,b,c){});q(g.comment);sendCallBack(f(!0,g));e.showProgressBar(!1)},600)}}catch(d){console.log("ERROR(WallController.addWallSubPost())"+d)}};a.removeWallPost=function(a,e,f){try{isDefine(e)||sendCallBack(f());isDefine(e)||sendCallBack(f());var g=JSON.stringify({dbcall:"db-remove",dbcollection:"wall",post_id:e.id,not_show_for:a.id});ajaxCall(pathServer+"remove-wall-post","remove-wall-post="+g,function(a,b,c){},function(a,b,c){});sendCallBack(f())}catch(b){console.log("ERROR(WallController.getRemovePost()): "+
b),sendCallBack(f())}};a.getPostById=function(a){try{if(!isDefine(a))return null;for(var e=0;e<l.listWallPosts.length;e++){var f=l.listWallPosts[e].post;if(f.id===a)return f}return null}catch(g){return console.log("ERROR(WallController.getPostById()): "+g),null}};return m}(thJQ);
