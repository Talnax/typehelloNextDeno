var item_db={owner:"2247-261-104-1585-35782953638",agent:{id:"4376-3076-3710-2624-109813903702",type:"web",activity:!0,date:"11-9-2015",language:"ru_ru",searchFor:"\u0441\u043e\u043b\u043d\u0446\u0435",isResultExist:!0,searchExclude:""}},th=th||{};th.next=th.next||{};
th.next.NewsHub=function(b){function s(){a=this;this.cssClassHub=".news-hub";this.hubStatus=statusHub.not_active;this.userPerClick=null;this.searchResults=[];this.newsChanged=this.collapseCss=!1;this.posFormatting=null;this.feedbackClass=".news-hub-dlg-feedback";this.settingsClass=".news-hub-dlg-settings";this.commonHub=new th.next.CommonHub(this);a.listViewCtrl=b("#result-list-view-ctrl");this.Initialize()}function q(b){try{b.preventDefault();var f=b.target,d=f.getAttribute("data-action");f.getAttribute("data-template-dlg");
if("function"===typeof a[d])a[d]();return!1}catch(e){return console.log("ERROR(NewsHub.onNewsMainMenu_Click()): "+e),!1}}function d(a){try{var f=a.target,d="-"===f.innerHTML?"none":"block",g="-"===f.innerHTML?"+":"-",c=b(this).parent().find("ul.list-results-per-agent");if("-"===g){var u=k(c[0].id);if(isDefine(u))f.innerHTML=g,b(c).css("display",d);else{var m={id:c[0].id,searchFor:c[0].getAttribute("data-search"),searchExclude:c[0].getAttribute("data-exclude")};setTimeout(function(a){e(a)},0,m)}}else f.innerHTML=
g,b(c).css("display",d)}catch(h){console.log("ERROR[NewsHub.onBtnExpander_Click()]: "+h)}}function e(r){try{a.showProgressBar(!0),b(".block-panel").css("display","block"),ctrlNews.getAgentResults(r,function(d,f){if(!d&&isDefine(f)){a:{var c=f;try{for(var g=[],m=[],h=0;h<c.length;h++){var t=decodeURIComponent(c[h].url);-1===m.indexOf(t)&&m.push(t)}t=[];for(h=0;h<c.length;h++){var e=decodeURIComponent(c[h].title);-1===t.indexOf(e)&&t.push(e)}if("noRepeatUrl"===(t.length<m.length?"noRepeatTitle":"noRepeatUrl"))for(var p=
0;p<m.length;p++)for(var l=0;l<c.length;l++){if(m[p]===decodeURIComponent(c[l].url)){g.push(c[l]);break}}else for(p=0;p<t.length;p++)for(l=0;l<c.length;l++)if(t[p]===decodeURIComponent(c[l].title)){g.push(c[l]);break}f=g;break a}catch(k){console.log("ERROR[NewsHub.noRepeatData()]: "+k)}f=void 0}c=b("#"+r.id);g=!1;for(m=0;m<f.length;m++)h=f[m],e=decodeURIComponent(h.title),e=90<e.length?e.slice(0,90)+"...":e,p=decodeURIComponent(h.url),0<h.url.length?(g=!0,l=new Date(h.date),l='<span class="date-value">'+
(l.getDate()+"-"+l.getMonth()+"-"+l.getFullYear())+"</span>",c.append('<li class="rss-agent-link" data-ref-id="'+h.ref+'"> - '+('<a href="'+p+'">'+e+"</a>")+l+"</li>")):console.log("NewsHub(Loop: content per agent: title + rssLink ): "+h.title+" : "+h.url);g&&(b(c).parent().find(".btn-expander").html("-"),b(c).css("display","block"))}a.showProgressBar(!1);b(".block-panel").css("display","none")})}catch(d){console.log("ERROR[NewsHub.showResultsForAgent()]: "+d)}}function k(a){try{var b=ctrlNews.listResultsPerAgent.length;
if(0<b)for(var d=0;d<b;d++)if(ctrlNews.listResultsPerAgent[d].id===a)return ctrlNews.listResultsPerAgent[d];return null}catch(e){console.log("ERROR(NewsController.getAgentResultsFromController())"+e)}}function n(d){try{if(!a.rssAgentTemplate){var f=b("#th-short-rss-agent-template").html();a.rssAgentTemplate=b(f)}if(0!==a.rssAgentTemplate.length){var e=29<d.searchFor.length?d.searchFor.slice(0,29)+"...":d.searchFor;b(a.rssAgentTemplate).find(".body-search").text(e);b(a.rssAgentTemplate).find(".date-value").text(d.date);
var g=a.rssAgentTemplate[0].outerHTML;return a.listViewCtrl.last().append(g)}}catch(c){return console.log("RssFeedAgentDialog.bindDataTemplateValues(): "+c),null}}var a,g=s.prototype;g.Initialize=function(){try{isDefine(ctrlNews)||(ctrlNews=new th.next.NewsController);a.commonHub.removeMainMenuItem(a,"news");this.initHub();a.commonHub.setHubPosition(a);a.hubStatus=statusHub.initialized;setTimeout(function(){a.readSearchAgents()},600);try{b(document).on("click",".news-hub ul.th-ul-main-menu li",q),
b(document).on("click",".list-agent-item .btn-expander",d)}catch(e){console.log("ERROR(NewsHub.setUIEvents()): "+e)}}catch(f){console.log("ERROR(NewsHub.Initialize())"+f)}};g.readSearchAgents=function(){try{var d=getUser();isDefine(d)&&(b("#result-list-view-ctrl li").remove(),ctrlNews.listAgents=[],ctrlNews.listResultsPerAgent=[],a.showProgressBar(!0),ctrlNews.getAgents(getUser(),function(d){a.showProgressBar(!1);if(isDefine(ctrlNews.listAgents)&&0!==ctrlNews.listAgents.length)for(var e=d=0;e<ctrlNews.listAgents.length;e++){var c=
ctrlNews.listAgents[e],f;a:{var m=c,h=d++;try{var g=n(ctrlNews.listAgents[h]);if(!isDefine(g)){f=null;break a}var r=b(g.children()[h]);r.append('<ul class="list-results-per-agent" '+("id='"+m.id+"'")+" "+("data-search='"+m.searchFor+"'")+" "+("data-exclude='"+m.searchExclude+"'")+" ></ul>").append("<hr>");var p=r.find("#"+m.id),l=b(p).parent().find(".btn-expander");f={ulResults:p,btnExpander:l};break a}catch(k){console.log("ERROR(NewsHub.addAgentNode())"+k)}f=void 0}isDefine(f)&&(c.hasOwnProperty("resultsAll")?
f.btnExpander[0].innerHTML="+":f.btnExpander.css("display","none"),f.ulResults.css("display","none"))}}))}catch(e){console.log("ERROR(NewsHub.readSearchAgents())"+e)}};g.refreshUI=function(a){try{b("#result-list-view-ctrl li").remove();for(var d=a.length;0<=d;d--)n(d,a[d])}catch(e){console.log("ERROR(NewsHub.refreshUI())"+e)}};g.initHub=function(){a.commonHub.initHub(a)};g.onMainMenuAction_Click=function(b){a.commonHub.onMainMenuAction_Click(a,b)};g.fromHubToHub=function(b,d){a.commonHub.fromHubToHub(a,
b,d)};g.hubShow=function(b){a.commonHub.hubShow(a,b);a.hubStatus=a.hubStatus<statusHub.active?statusHub.active:a.hubStatus};g.hubRemove=function(){a.commonHub.hubRemove.call(this)};g.showProgressBar=function(b){a.commonHub.showProgressBar(a,b)};g.getHubStatus=function(b){return a.hubStatus};g.openSearchAgentsDld=function(){try{isDefine(a.dlgSearchAgent)||(a.dlgSearchAgent=new th.next.SearchAgentsDialog,a.dlgSearchAgent.parentWnd=a),a.dlgSearchAgent.OpenDlg(a.cssClassHub,a.cssClassHub+" .news-list")}catch(b){console.log("ERROR[NewsHub.openSearchAgentsDld()]: "+
b)}};return s}(thJQ);
th.next.SearchAgentsDialog=function(b){function s(){c=this;this.cssDlgId="#rss-agent-dlg";this.rssAgentTemplate=this.newsTemplate=null;this.dlgShown=!1;this.parentWnd=null;this.changeAgent=!1;this.Initialize()}function q(a){try{return a.preventDefault(),c.dialogCtrl.hasClass("invisible-item")||(c.dialogCtrl.addClass("invisible-item"),f(!0),c.changeAgent&&(c.changeAgent=!1,c.parentWnd.readSearchAgents())),!1}catch(b){return console.log("SearchAgentsDialog.onCloseDld_Click(): "+b),!1}}function d(a){try{a.preventDefault();
var d=w(a);if(!isDefine(d))return!1;g(d);ctrlNews.listAgents.push(d);r(!0);ctrlNews.addAgent(d,c,function(a){r(!1);c.changeAgent=!0;try{b("#input-agent-news-body").val(""),b("#input-agent-exclude").val("")}catch(d){console.log("SearchAgentsDialog.resetAgentCtrls(): "+d)}});return!1}catch(e){return console.log("SearchAgentsDialog.onAddAgent_Click(): "+e),!1}}function e(a){try{var d=b(a.target).closest("li.list-agent-item");if(isDefine(d)){var e=d.index();ctrlNews.removeAgent(ctrlNews.listAgents[e],
c,function(a){d.remove();c.changeAgent=!0;ctrlNews.listAgents.splice(e,1);0===ctrlNews.listAgents.length&&v(!1)})}return!1}catch(f){return console.log("SearchAgentsDialog.onRemoveAgent_Click(): "+f),!1}}function k(a){try{n(a.target)}catch(b){console.log("SearchAgentsDialog.onBtnExpander_Click(): "+b)}}function n(a){try{var d=a.innerHTML,c="";"list-agents-expander"===a.id?c="#list-agents-ctrl":"new-agent-expander"===a.id&&(c=".new-agent-params");var e="-"===d?"none":"block";a.innerHTML="-"===d?"+":
"-";b(c).css("display",e)}catch(f){console.log("SearchAgentsDialog.onExpanderAction(): "+f)}}function a(){try{b(document).on("mouseenter","#list-agents-ctrl li",function(a){b(this).find(".btn-circle").css("opacity","1.0")}),b(document).on("mouseleave","#list-agents-ctrl li",function(a){b(this).find(".btn-circle").css("opacity","0.0")}),b(document).on("click","#close-rss-agent-dlg",q),b(document).on("click","#add-rss-agent-btn",d),b(document).on("click","#list-agents-ctrl li .btn-remove-agent-item",
e),b(document).on("click","#list-agents-expander",k),b(document).on("click","#new-agent-expander",k)}catch(a){console.log("SearchAgentsDialog.setUIEvents(): "+a)}}function g(a){try{if(!c.rssAgentTemplate){var d=b("#th-rss-agent-template-dlg").html();c.rssAgentTemplate=b(d)}if(0!==c.rssAgentTemplate.length){b(c.rssAgentTemplate).find(".langs-search").text(a.language);b(c.rssAgentTemplate).find(".body-search").text(a.searchFor);b(c.rssAgentTemplate).find(".body-exclude").text(a.searchExclude);var e=
c.rssAgentTemplate[0].outerHTML;c.listAgentsCtrl.last().append(e);v(!0)}}catch(f){console.log("SearchAgentsDialog.addAgentTemplate(): "+f)}}function r(a){try{c.dlgProgressBar.css("display",a?"block":"none"),c.uiBlockerPanel.css("display",a?"block":"none")}catch(b){console.log("SearchAgentsDialog.showProgressBar(): "+b)}}function f(a){try{b(c.parentHub).css("width",a?"330px":"300px"),b(c.parentHub+" .th-cover").css("box-shadow",a?"0 0 30px rgba(0,0,0,0.6),inset 0 0 30px rgba(0,0,0,0.15)":"none"),b(c.contentOfHub).css("display",
a?"block":"none")}catch(d){console.log("SearchAgentsDialog.showParentHub(): "+d)}}function v(a){try{c.listAgentsPanel.css("display",a?"block":"none"),c.btAgentExpander.css("display","none"),a=a?" none !important":" block  !important",c.btAgentExpander.siblings().closest("hr").attr("style","display: "+a)}catch(b){console.log("SearchAgentsDialog.showListOfAgents(): "+b)}}function w(a){try{var d=b("#rss-agent-dlg .search-languages .search-languages-items").val(),c=b("#input-agent-news-body").val();return 0===
c.length?(alert("Please fill searching request"),null):{id:GUID(),type:"web",activity:!0,date:getCurrentDate(),language:d,searchFor:c,searchExclude:""}}catch(e){console.log("SearchAgentsDialog.collectAgentData(): "+e)}}var c,u=s.prototype;u.Initialize=function(){try{isDefine(ctrlNews)||(ctrlNews=new th.next.NewsController),c.dialogCtrl=b("#rss-agent-dlg"),c.listAgentsPanel=b("#rss-agent-dlg .agent-rss-panel .list-agents-panel"),c.listAgentsCtrl=b("#list-agents-ctrl"),c.btAgentExpander=b("#new-agent-expander"),
c.dlgProgressBar=b("#rss-agent-dlg .th-dlg-progress-bar"),c.uiBlockerPanel=b("#th-ui-blocker-panel"),a(),n(b("#list-agents-expander")[0])}catch(d){console.log("ERROR(SearchAgentsDialog.Initialize())"+d)}};u.OpenDlg=function(a,d){try{if(c.parentHub=a,c.contentOfHub=d,f(!1),c.dlgShown)c.dialogCtrl.removeClass("invisible-item");else if(c.dlgShown=!0,c.dialogCtrl.removeClass("invisible-item"),v(!1),r(!1),isDefine(ctrlNews.listAgents))for(var b=0;b<ctrlNews.listAgents.length;b++)g(ctrlNews.listAgents[b])}catch(e){console.log("SearchAgentsDialog.OpenDlg(): "+
e)}};return s}(thJQ);
th.next.NewsController=function(b){function s(){q=this;this.listAgents=[];this.listResultsPerAgent=[];this.Initialize()}var q;b=s.prototype;b.Initialize=function(){};b.getAgents=function(b,e){try{if(!isDefine(b))return sendCallBack(e(!1));var k=JSON.stringify({dbcollection:"search_agents",dbrequest:{owner:b.id,"agent.type":"web","agent.activity":!0},dbreturn:{_id:0}});ajaxCall(pathServer+"get-search-agents","get-search-agents="+k,function(a,b,d){if(isJsonData(a)){a=JSON.parse(a);if(!0===a.err)return sendCallBack(e(!1));
if("object"===typeof a.param&&Array.isArray(a.param))return a.param.forEach(function(a){a=a.agent;q.decodeAgent(a);q.listAgents.push(a)}),sendCallBack(e(!0))}return sendCallBack(e(!1))},function(a,b,d){console.log("ERROR[NewsController.getAllAgents()]: "+d);return sendCallBack(e(!1))})}catch(n){console.log("ERROR(NewsController.getAllAgents())"+n)}};b.addAgent=function(b,e,k){try{if(isDefine(b)){q.encodeAgent(b);var n={dbcollection:"search_agents",dbrequest:{owner:getUser().id,agent:b}},a=JSON.stringify(n);
ajaxCall(pathServer+"add-search-agent","add-search-agent="+a,function(a,b,d){return sendCallBack(k(!0))},function(a,b,d){console.log("add new AGENT Fail... -"+d);return sendCallBack(k(!1))})}}catch(g){console.log("ERROR(NewsController.addNews())"+g)}};b.removeAgent=function(b,e,k){try{if(isDefine(b)){q.encodeAgent(b);var n={dbcollection:"search_agents",dbfind:{owner:getUser().id,"agent.id":b.id},dbupdate:{$set:{"agent.activity":!1}}},a=JSON.stringify(n);ajaxCall(pathServer+"remove-search-agent","remove-search-agent="+
a,function(a,b,d){return sendCallBack(k(!0))},function(a,b,d){console.log("add new AGENT Fail... -"+d);return sendCallBack(k(!1))})}}catch(g){console.log("ERROR(NewsController.removeAgent())"+g)}};b.getAgentResults=function(b,e){try{isDefine(b)||sendCallBack(e(!1));q.encodeAgent(b);var k=JSON.stringify({dbcollection:"search_results",dbrequest:{searchFor:b.searchFor,searchExclude:b.searchExclude},dbreturn:{_id:0,results:1}});ajaxCall(pathServer+"get-agent-results","get-agent-results="+k,function(a,
g,k){if(isJsonData(a))if(a=JSON.parse(a),!0===a.err)sendCallBack(e(!0,null));else return a=a.param,0<a.length?(a=a[0].results,q.listResultsPerAgent.push({id:b.id,searchFor:b.searchFor,searchExclude:b.searchExclude,results:a}),sendCallBack(e(!1,a))):sendCallBack(e(!0,null));else return sendCallBack(e(!0,null))},function(a,b,d){console.log("ERROR[NewsController.getAllAgents()]: "+d);return sendCallBack(e(!1))})}catch(n){console.log("ERROR(NewsController.getAgentResults())"+n)}};b.encodeAgent=function(b){try{isDefine(b)&&
(b.searchFor=encodeURIComponent(encodeLineBreaksNew(b.searchFor)),b.excludeSearch=encodeURIComponent(encodeLineBreaks(b.excludeSearch)))}catch(e){console.log("ERROR(NewsController.encodeAgent())"+e)}};b.decodeAgent=function(b){try{isDefine(b)&&(b.searchFor=decodeURIComponent(decodeLineBreaksNew(b.searchFor)))}catch(e){console.log("ERROR(NewsController.decodeAgent())"+e)}};return s}(thJQ);
