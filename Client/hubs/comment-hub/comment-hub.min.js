th.next.CommentHub=function(b){function k(){a=this;this.cssClassHub=".comment-hub";this.hubStatus=statusHub.not_active;this.commentCommentTemplate=this.commentTemplate=this.userPerClick=null;this.feedbackClass=".comment-hub-dlg-feedback";this.commonHub=new th.next.CommonHub(this);this.Initialize()}function n(e){try{e.preventDefault();var b=e.target,h=b.getAttribute("data-action"),r="."+b.getAttribute("data-template-dlg");if("function"===typeof a.commonHub[h])a.commonHub[h](a,r,!1,function(e,b){"showCommentItemDlg"===
h&&!0===e&&(ctrlComment.listComments.push({post:b}),a.refreshUI())});else if("function"===typeof a[h])a[h]();return!1}catch(d){return console.log("CommentHub.onCommentMainMenu_Click(): "+d),!1}}function l(e){try{e.preventDefault();a.userPerClick=getUserPerDataTemplate("comment-list-view-item-template",e);var b=e.target,h=b.getAttribute("data-action"),d="."+b.getAttribute("data-template-dlg");a.commonHub[h](a,d,!0,function(e,b){if("showCommentItemDlg"===h&&!0===e)for(var d=0;d<ctrlComment.listComments.length;d++){var p=
ctrlComment.listComments[d].post;if(p.id===b.post_id){p.comments.push(b.comment);a.refreshUI();break}}});return!1}catch(c){return console.log("ERROR(CommentHub.onUserAction_Click()): "+c),!1}}function d(){try{b(document).on("click",".comment-hub .th-user-actions li",l),b(document).on("click",".comment-hub ul.th-ul-main-menu li",n),b(document).on("mouseenter","#comment-list-view-ctrl li",function(a){b(this).find(".th-user-actions").css("opacity","1.0")}),b(document).on("mouseleave","#comment-list-view-ctrl li",
function(a){b(this).find(".th-user-actions").css("opacity","0.0")})}catch(a){console.log("ERROR(CommentHub.setUIEvents()): "+a)}}function c(){try{var e=parseInt(b(a.cssClassHub).css("width"));b(a.cssClassHub).css("left",parseInt(window.innerWidth-e-36)+"px")}catch(d){console.log("ERROR(CommentHub.rePositionHub())"+d)}}function f(e,d){try{if(isDefine(d)){if(!a.commentTemplate){var h=b("#comment-item-template").html();a.commentTemplate=b(h)}if(0!==a.commentTemplate.length){var c=d.post;c.sender.post_id=
d.post.id;var g=JSON.stringify(c.sender);b(a.commentTemplate).find(".template-data span").text(g);b(a.commentTemplate).find(".template-date span").text(c.date);b(a.commentTemplate).find(".template-nick span").text(c.sender.nick);b(a.commentTemplate).find(".template-text span").text(c.msg);b(a.commentTemplate).find(".template-link a").text(c.link);b(a.commentTemplate).find(".template-link a").attr("href",c.link);var f=b(a.commentTemplate).find(".template-pic img");""===c.pic?(f.attr("src",""),f.css("margin-top",
"0"),f.css("margin-bottom","0"),f.css("visibility","hidden")):f.attr("src",c.pic);var k=b(a.commentTemplate).find(".template-image");a.commonHub.setUserIcon(k,c.sender);var l=a.commentTemplate[0].outerHTML;b("#comment-list-view-ctrl").last().append("<li>"+l+"</li>");k[0].removeAttribute("style");f[0].removeAttribute("style");for(h=0;h<c.comments.length;h++){var m=c.comments[h];try{if(!a.commentCommentTemplate){var n=b("#comment-item-comment-template").html();a.commentCommentTemplate=b(n)}if(0!==a.commentCommentTemplate.length){m.sender.post_id=
m.id;var s=JSON.stringify(m.sender);b(a.commentCommentTemplate).find(".template-data span").text(s);b(a.commentCommentTemplate).find(".template-date span").text(m.date);b(a.commentCommentTemplate).find(".template-nick span").text(m.sender.nick);b(a.commentCommentTemplate).find(".template-text span").text(m.msg);var q=b(a.commentCommentTemplate).find(".template-image");a.commonHub.setUserIcon(q,m.sender);var t=a.commentCommentTemplate[0].outerHTML;b(".comment-list-view-comments-ctrl").last().append("<li>"+
t+"</li>");q[0].removeAttribute("style")}}catch(u){console.log("ERROR(CommentHub.bindDataTemplateSubValues())"+u)}}}}}catch(v){console.log("ERROR(CommentHub.bindDataTemplateValues())"+v)}}var a,g=k.prototype;g.Initialize=function(){try{a.commonHub.removeMainMenuItem(a,"comment"),this.initHub(),a.commonHub.setHubPosition(a),a.hubStatus=statusHub.initialized,setTimeout(function(){a.readAllCommentPosts()},600),d(),c()}catch(b){console.log("ERROR(CommentHub.Initialize())"+b)}};g.readAllCommentPosts=function(){try{var e=
getUser();isDefine(e)&&(isDefine(ctrlComment)||(ctrlComment=new th.next.CommentController),a.showProgressBar(!0),b("#comment-list-view-ctrl li").remove(),ctrlComment.listComments=[],ctrlComment.getCommentPosts(e,function(b){a.showProgressBar(!1);for(b=0;b<ctrlComment.listComments.length;b++)f(b,ctrlComment.listComments[b])}))}catch(d){console.log("ERROR(CommentHub.readAllCommentPosts())"+d)}};g.refreshUI=function(){try{b("#comment-list-view-ctrl li").remove();for(var a=ctrlComment.listComments.length-
1;0<=a;a--)f(a,ctrlComment.listComments[a])}catch(d){console.log("ERROR(CommentHub.refreshUI())"+d)}};g.initHub=function(){a.commonHub.initHub(a)};g.onMainMenuAction_Click=function(b){a.commonHub.onMainMenuAction_Click(a,b)};g.fromHubToHub=function(b,d){a.commonHub.fromHubToHub(a,b,d)};g.hubShow=function(b){a.commonHub.hubShow(a,b);a.hubStatus=a.hubStatus<statusHub.active?statusHub.active:a.hubStatus};g.hubRemove=function(){a.commonHub.hubRemove.call(this)};g.showProgressBar=function(b){a.commonHub.showProgressBar(a,
b)};g.getHubStatus=function(b){return a.hubStatus};return k}(thJQ);
th.next.CommentController=function(b){function k(){l=this;this.listComments=[];this.Initialize()}function n(b){try{b.msg=decodeURIComponent(b.msg),b.pic=decodeURIComponent(b.pic),b.link=decodeURIComponent(b.link)}catch(c){console.log("ERROR(CommentController.decodePost())"+c)}}var l;b=k.prototype;b.Initialize=function(){};b.getCommentPosts=function(b,c){try{if(!(0<l.listComments.length)&&isDefine(b)){var f={dbcall:"db-comment",dbcollection:"comment",dbrequest:{url:encodeURIComponent(removeLineBreaks(document.URL))},
dbreturn:{post:1}},a=JSON.stringify(f);ajaxCall(pathServer+"get-comment-posts","get-comment-posts="+a,function(a,b,d){if(isJsonData(a)&&(a=JSON.parse(a),"object"===typeof a.param)){l.listComments=a.param;sendCallBack(c(!0));return}sendCallBack(c(!1))},function(a,b,d){console.log("ERROR[CommentController.getAllCommentItems()]: "+d);sendCallBack(c(!1))})}}catch(g){console.log("ERROR(CommentController.getCommentPosts())"+g)}};b.addCommentPost=function(b,c,f,a,g){try{a.showProgressBar(!0);b=encodeURIComponent(removeLineBreaks(b));
f=isDefine(f)?encodeURIComponent(removeLineBreaks(f)):"";c=isDefine(c)?encodeURIComponent(removeLineBreaks(c)):"";var e={dbcall:"db-add",dbcollection:"comment",dbrequest:{url:encodeURIComponent(removeLineBreaks(document.URL)),post:{id:GUID(),sender:getUserId(getUser()),date:getCurrentDate(),msg:b,link:c,pic:f,comments:[]}}},k=JSON.stringify(e);ajaxCall(pathServer+"add-comment-post","add-comment-post="+k,function(a,b,c){},function(a,b,c){});n(e.dbrequest.post);sendCallBack(g(!0,e.dbrequest.post));
a.showProgressBar(!1)}catch(h){console.log("ERROR(CommentController.addCommentPost())"+h)}};b.addCommentSubPost=function(b,c,f){try{b=encodeURIComponent(removeLineBreaks(b));var a={post_id:c.userPerClick.post_id,comment:{id:GUID(),sender:getUserId(getUser()),date:getCurrentDate(),msg:b,link:"",pic:""}};c.showProgressBar(!0);var g=JSON.stringify(a);setTimeout(function(){ajaxCall(pathServer+"add-comment-sub-post","add-comment-sub-post="+g,function(a,b,c){},function(a,b,c){});n(a.comment);sendCallBack(f(!0,
a));c.showProgressBar(!1)},600)}catch(e){console.log("ERROR(CommentController.addCommentSubPost())"+e)}};return k}(thJQ);
