var th=th||{};th.next=th.next||{};
th.next.TalkHub=function(c){function m(){a=this;this.cssClassHub=".talk-hub";this.hubStatus=statusHub.not_active;this.chatTemplate=this.activeChannel=null;this.channelTabs=0;this.liItemTemplate=this.userPerClick=this.argsDlgFilter=null;this.feedbackClass=".talk-hub-dlg-feedback";this.commonHub=new th.next.CommonHub(this);this.Initialize()}function y(b){try{b.preventDefault();if(1===a.channelTabs)k("Oops, you can't delete last channel :(");else{var h=z(a.activeChannel);null!==h&&Socket.emit(socketEvents.socket_close_chat,
{user:getUser(),remove_channel:h})}return!1}catch(d){return console.log("ERROR(TalkHub.actionMakePersonAs()): "+d),!1}}function A(b){try{b.preventDefault();var a=c(this).closest("li")[0].getAttribute("data-url");s(a);return!1}catch(d){return console.log("ERROR(TalkHub.onChannelTab_Click()): "+d),!1}}function B(b){try{b.preventDefault();var h=b.target,d=h.getAttribute("data-action"),e="."+h.getAttribute("data-dlg");a.commonHub["show"+d](a,e,function(b){"DlgPerTheme"===d?a.socketOpenChat({url:b,type:channelType._special,
kind:channelKind.text}):"DlgPerFilter"===d&&null!==b&&(a.argsDlgFilter=b)});return!1}catch(g){return console.log("TalkHub.onTalkMainMenu_Click(): "+g),!1}}function D(b){try{b.preventDefault();var h=getUser(),d=getUserPerDataTemplate("chat-list-view-item-template",b),e=b.target.className.split(" ")[0];a.userPerClick=USERs[d.user_id];var g=c(this).closest(".chat-list-view-item-template");a.liItemTemplate=g[0].parentNode;switch(e){case "make-person-as":E(h);break;case "private-chat":a.buildPrivateChannel(h,
a.userPerClick);break;case "send-sms":F();break;case "full-profile":G();break;case "ignore-user":try{isDefine(h)&&(a.userPerClick.id===getUser().id?k("Do you want ignore yourself ?"):ctrlIgnore&&ctrlIgnore.isUserIgnore(a.userPerClick)?k("This person already in ignore list :)"):a.commonHub.showIgnoreDlg(a,".show-dlg-ignore"))}catch(C){console.log("ERROR(TalkHub.actionIgnoreUser()): "+C)}}return!1}catch(f){return console.log("ERROR(TalkHub.onUserAction_Click()): "+f),!1}}function t(b){try{b.preventDefault();
var h=document.getElementById("chat-message"),d=h.value.trim();if(1>d.length)return!1;var e=getUser(),g=a.activeChannel?a.activeChannel:document.URL,c=isDefine(l[g])?l[g].channel.type:channelType._public;Socket.emit(socketEvents.socket_msg_chat,{text:d,user:e,channel:{url:g,type:c}});h.value="";return!1}catch(f){return console.log("ERROR(TalkHub.onMessageChat_Click()): "+f),!1}}function H(b){try{return b.preventDefault(),delCookie(storageNick,""),location.reload(),!1}catch(a){return console.log("ERROR(TalkHub.onUserAction_Click()): "+
a),!1}}function I(){var b=document.getElementById("chat-message");isDefine(b)&&setTimeout(function(){b.focus()},0)}function s(b){try{if(a.activeChannel!==b){p(a.activeChannel,0.2);u(b,"");q();v(b);var h=document.getElementById("messages-chat");h.scrollTop=h.scrollHeight;a.activeChannel=b;setActiveChannel(a.activeChannel);p(a.activeChannel,1);c("#chat-message").val("");r(a.activeChannel)}}catch(d){console.log("ERROR(TalkHub.changeActiveChannelTab()): "+d)}}function J(){try{c("#btn-send-chat-message").click(t),
c("#chat-message").keyup(function(b){13===b.keyCode&&t(b)}),c(document).on("mouseenter","#messages-chat li",function(b){c(this).find(".th-user-actions").css("opacity","1.0")}),c(document).on("mouseleave","#messages-chat li",function(b){c(this).find(".th-user-actions").css("opacity","0.0")}),c(document).on("click","#messages-chat li ul.th-user-actions li span",D),c(document).on("click",".talk-hub ul.th-ul-main-menu li",B),c(document).on("click","ul.ul-tabs-chat-menu li",A),c(document).on("click",".btn-close-channel",
y),c(document).on("click","#th-link-log-out",H)}catch(b){console.log("ERROR(TalkHub.setUIEvents()): "+b)}}function u(b,a){try{""===a&&(l[b].msg_counter=1),c("ul.ul-tabs-chat-menu li").each(function(d){c(this).attr("data-url")===b&&c(this).find(".msg_counter").html(a)})}catch(d){console.log("ERROR(TalkHub.updateMessageCounter()): "+d)}}function z(b){try{for(var h in l)if(l.hasOwnProperty(h)){var d=l[h];if(a.activeChannel!==d.channel.url){a.activeChannel=d.channel.url;setActiveChannel(a.activeChannel);
break}}q();p(a.activeChannel,1);delete l[b];v(a.activeChannel);c("ul.ul-tabs-chat-menu li").each(function(a){c(this).attr("data-url")===b&&c(this).remove()});var e=K(b);r(a.activeChannel);a.channelTabs--;return e}catch(g){return console.log("ERROR(TalkHub.removeChannel()): "+g),null}}function q(){try{null!==a.activeChannel&&(c("#messages-chat > li").remove(),c("#messages-chat").append(a.chatTemplate))}catch(b){console.log("ERROR(TalkHub.cleanChatPanel()): "+b)}}function r(b){try{var a=l[b],d=null;
if(a)var e=a.channel.type,c=decodeURIComponent(a.channel.url).replace("?",""),c=90<c.length?c.slice(0,90)+"...":c,d=e===channelType._public?"PUBLIC://"+c:e===channelType._private?"PRIVATE://*********":e===channelType._friends?"FRIENDS://*********":"SPECIAL://"+c;var f=document.querySelectorAll("#th-active-url");0<f.length&&(f[0].innerHTML=d?d:b)}catch(k){console.log("ERROR(TalkHub.showChatUrl()): "+k)}}function F(){a.commonHub.showSmsDlg(a,".show-dlg-sms",function(b){})}function G(){a.commonHub.showProfileDlg(a,
".show-dlg-profile",function(b){})}function w(b){try{if(isDefine(b)&&(a.chatTemplate||(a.chatTemplate=c(".chat-list-view-item-template.template-item")),0!==a.chatTemplate.length)){var h=JSON.stringify({user_id:b.user.id});c(a.chatTemplate).find(".template-data span").text(h);c(a.chatTemplate).find(".template-date span").text(getCurrentDate());c(a.chatTemplate).find(".template-msg span").text(b.msg);c(a.chatTemplate).find(".template-nick span").text(b.user.nick);var d=c(a.chatTemplate).find(".template-image");
a.commonHub.setUserIcon(d,b.user);var e=a.chatTemplate[0].outerHTML.replace("template-item","");c("#messages-chat").append("<li>"+e+"</li>");d[0].removeAttribute("style")}}catch(g){console.log("ERROR(TalkHub.bindDataTemplateValues()): "+g)}}function p(b,a){try{c("ul.ul-tabs-chat-menu li").each(function(d){c(this).attr("data-url")===b&&c(this).find("div.tab-chat-menu-icon").css("opacity",a)})}catch(d){console.log("ERROR(TalkHub.disableChannel()): "+d)}}function v(b){try{var a=l[b];if(a){var d=a.messages;
if(d)for(var c in d)d.hasOwnProperty(c)&&w(d[c])}}catch(g){console.log("ERROR(TalkHub.setMessagesPerChannel()): "+g)}}function x(a,c){try{return isDefine(l[a.url])?!0:!1}catch(d){return console.log("ERROR(TalkHub.isChannelPerUserExist()): "+d),!1}}function K(a){try{var c=null,d=getUser(),e;for(e in d.channels)if(d.channels.hasOwnProperty(e)&&d.channels[e].url===a){c=d.channels[e];d.channels.splice(e,1);break}return c}catch(g){return console.log("ERROR(TalkHub.removeChannelPerUserExist()): "+g),null}}
function k(b){a.commonHub.showInfoDlg(a,".talk-hub-dlg-info",b,function(a){})}function E(b){try{if(isDefine(b))if(b.id===a.userPerClick.id)k("You can't make friend of yourself :)");else{var c=function(b,d,c){a.showProgressBar(!1);b=JSON.parse(b);"object"===typeof b?1===b.param?k("This user already in your person's list"):a.commonHub.showMakePersonAsDlg(a,".show-dlg-make-person-as"):k("We can't get data from server :(")},d=function(b,d,c){console.log("ERROR[TalkHub->ctrlPerson.isPersonOfUser()]: "+
c);a.showProgressBar(!1);k("We can't get data from server :(")};a.commonHub.getHub(ctrlPerson,"person-hub",function(e){e.init&&(ctrlPerson=new th.next.PersonController);setTimeout(function(){ctrlPerson.isPersonOfUser(b,a.userPerClick,"friend",c,d)},600)});a.showProgressBar(!0)}}catch(e){console.log("ERROR(TalkHub.actionMakePersonAs()): "+e),a.showProgressBar(!1)}}var a,f=m.prototype,l={};f.Initialize=function(){try{a.commonHub.removeMainMenuItem(a,"talk"),this.initHub(),J(),I(),a.commonHub.setHubPosition(a),
this.hubStatus=statusHub.initialized}catch(b){console.log("ERROR(TalkHub.Initialize()): "+b)}};f.buildPrivateChannel=function(b,c){try{if(c.id===b.id)k("Hey, you can't create private chat with yourself :)");else{var d=b.id.split("-"),e=c.id.split("-"),g={url:buildChannel(d[0]+d[1],e[0]+e[1]),type:channelType._private,kind:channelKind.text};a.userPerClick=c;a.socketOpenChat(g)}}catch(f){console.log("ERROR(TalkHub.buildPrivateChannel()): "+f)}};f.socketOpenChat=function(b){try{if(8<a.channelTabs)k("You can't create more then 9 channels");
else{var c=getUser();if(x(b,c))k("This channel already exist!");else{var d={user:c,new_channel:b,anyone:null};Socket.emit(socketEvents.socket_open_chat,d);b.type===channelType._private&&(d={user:a.userPerClick,new_channel:b,anyone:c},Socket.emit(socketEvents.socket_open_chat,d))}}}catch(e){console.log("ERROR(TalkHub.socketOpenChat()): "+e)}};f.socketOpenChat_Completed=function(b,h){try{var d=getUser();if(x(b.channel,d))b.channel.type===channelType._private&&(a.hubShow(!0),s(b.channel.url));else{b.anyone&&
alert(b.anyone.nick+" want to talk to you private!");var e=b.channel;try{l[e.url]={channel:e,messages:[]};d.channels.push(e);try{var g=null,g=e.type===channelType._public?"public":e.type===channelType._private?"private":e.type===channelType._friends?"friends":"special",f='<li data-action="'+g+'" data-url="'+e.url+'"><div class="msg_counter"></div>'+('<div class="tab-chat-menu-icon talk-'+g+'-channel" title="'+g+' channel"></div>')+"</li>";c("ul.ul-tabs-chat-menu").append(f)}catch(k){console.log("ERROR(TalkHub.setChatIcon()): "+
k)}r(e.url);q();null!==a.activeChannel&&p(a.activeChannel,0.2);a.activeChannel=e.url;setActiveChannel(a.activeChannel);c("#chat-message").val("");a.channelTabs++}catch(n){console.log("ERROR(TalkHub.addChannel()): "+n)}!1!==b.isError.status?(console.log(b.msg),c("#messages-server").append('<li class="red-frg">'+b.isError.value+"</item>")):c("#messages-server").append("<li>Connect to channel...</item>");Socket.emit(socketEvents.socket_msg_chat,{text:b.channel.type===channelType._private?"Connect to private channel...":
"Join the channel...",user:d,channel:b.channel})}}catch(m){console.log("ERROR(TalkHub.socketOpenChat_Completed()): "+m)}};f.socketMessageChat_Completed=function(b,c){try{var d;var e=b.user,f=getUser();try{d=e.id===f.id?!0:a.argsDlgFilter&&(a.argsDlgFilter.hasOwnProperty("country")&&a.argsDlgFilter.country!==e.country||a.argsDlgFilter.hasOwnProperty("gender")&&a.argsDlgFilter.gender!==e.gender||a.argsDlgFilter.hasOwnProperty("language")&&a.argsDlgFilter.language!==e.language||a.argsDlgFilter.hasOwnProperty("nick")&&
0>e.nick.indexOf(a.argsDlgFilter.nick))?!1:!0}catch(k){console.log("ERROR(TalkHub.checkFilter()): "+k),d=!1}if(d){if(a.activeChannel===b.channel.url){w(b);var m=document.getElementById("messages-chat");m.scrollTop=m.scrollHeight}isDefine(USERs[b.user.id])||(USERs[b.user.id]=b.user);var n=l[b.channel.url];n&&(n.messages.push({user:b.user,msg:b.msg}),a.activeChannel!==b.channel.url&&(n.hasOwnProperty("msg_counter")?n.msg_counter+=1:n.msg_counter=1,u(b.channel.url,n.msg_counter)))}}catch(p){console.log("ERROR(TalkHub.socketMessageChat_Completed()): "+
p)}};f.socketSendSmsNotification=function(a){try{Socket.emit(socketEvents.socket_sms_notification,a)}catch(c){console.log("ERROR(TalkHub.socketSendSms()): "+c)}};f.initHub=function(){a.commonHub.initHub(a)};f.onMainMenuAction_Click=function(b){a.commonHub.onMainMenuAction_Click(a,b)};f.fromHubToHub=function(b,c){a.commonHub.fromHubToHub(a,b,c)};f.hubShow=function(b){a.commonHub.hubShow(a,b);a.hubStatus=a.hubStatus<statusHub.active?statusHub.active:a.hubStatus};f.hubRemove=function(){a.commonHub.hubRemove.call(this)};
f.showProgressBar=function(b){a.commonHub.showProgressBar(a,b)};f.getHubStatus=function(b){return a.hubStatus};return m}(thJQ);th.next.TalkController=function(c){function m(){this.Initialize()}m.prototype.Initialize=function(){};return m}(thJQ);
